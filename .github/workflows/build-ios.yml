name: 'Build iOS'

on:
  push:
    branches:
      - main
      - release
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim

      - name: Install frontend dependencies
        working-directory: ./app
        run: bun install

      - name: Build iOS App (Unsigned)
        working-directory: ./app
        run: |
          # 重点：
          # 1. --target aarch64 : 明确告诉它我们要编真机版(arm64)，不是模拟器
          # 2. -- (双横杠) : 把后面的参数透传给 xcodebuild
          # 3. CODE_SIGNING_ALLOWED=NO : 强行关掉签名
          
          bun tauri ios build --target aarch64 -- \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            PROVISIONING_PROFILE=""

      
      - name: Package App for Distribution
        run: |
          mkdir -p ios-artifacts
          
          echo "Searching for .app bundle..."
          # 稍微放宽搜索条件，防止因为路径变动找不到
          # 排除掉模拟器(iphonesimulator)的包，只找真机(iphoneos)的包
          APP_PATH=$(find app/src-tauri/gen/apple/build -type d -name "*.app" | grep -v "iphonesimulator" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "::error::Could not find .app bundle! Check build logs."
            find app/src-tauri/gen/apple/build -type d -name "*.app" # 打印出来看看都在哪
            exit 1
          fi
          
          echo "Found app at: $APP_PATH"
          
          # 创建 Payload 文件夹 (这是 IPA 的标准结构)
          rm -rf Payload
          mkdir Payload
          
          # 复制 .app 进去
          cp -r "$APP_PATH" Payload/
          
          # 压缩成 IPA
          zip -r "ios-artifacts/todo-app-unsigned.ipa" Payload
          
          # 顺便把 .app 也压个包，万一你要用模拟器测
          APP_NAME=$(basename "$APP_PATH")
          zip -r "ios-artifacts/$APP_NAME.zip" "$APP_PATH"
          
          echo "Packaging done:"
          ls -l ios-artifacts/


      - name: Upload Artifacts to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ios-artifacts/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifacts to Action Run
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: ios-artifacts/*
          if-no-files-found: warn
