name: "Build iOS"

on:
  push:
    branches:
      - release
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # 2. 安装依赖
      - name: Install Dependencies
        working-directory: ./app
        run: bun install

      # 3. 这里的关键：只让 Tauri 初始化项目并构建前端，不要让它尝试打包 IPA
      # 如果你的 tauri.conf.json 里的 bundle identifier 是自动生成的，确保它是固定的
      - name: Build Frontend & Init iOS Project
        working-directory: ./app
        run: |
          bun tauri build --no-bundle
          bun tauri ios init

      # 3.1 启动 Tauri iOS options server（xcode-script 需要读取它）
      - name: Start Tauri iOS Options Server
        working-directory: ./app
        run: |
          bun tauri ios build --open --ci >/tmp/tauri-ios-options.log 2>&1 &
          echo "TAURI_IOS_OPTIONS_PID=$!" >> "$GITHUB_ENV"
          sleep 6
      - name: Show Options Server Log (on failure)
        if: failure()
        run: |
          if [ -f /tmp/tauri-ios-options.log ]; then
            echo "---- /tmp/tauri-ios-options.log (tail) ----"
            tail -n 200 /tmp/tauri-ios-options.log
          fi

      # 4. 用 xcodebuild 直接 build（不 archive），避免必须要 provisioning profile
      # 解释参数：
      # - CODE_SIGNING_ALLOWED="NO": 不进行签名
      # - CODE_SIGNING_REQUIRED="NO": 不强制签名
      # - CODE_SIGNING_IDENTITY="": 清空签名身份
      # 用 find 命令找到 .xcodeproj，适应 tauri v1 或 v2 的路径差异
      - name: Xcode Build (Unsigned)
        run: |
          cd app/src-tauri/gen/apple

          # 获取 workspace 名称 (通常是 项目名.xcodeproj)
          XCODE_PROJECT=$(find . -name "*.xcodeproj" -maxdepth 1 | head -n 1)

          # 动态获取 Scheme 名称
          # xcodebuild -list 的输出包含了 Schemes: 接下来的行
          echo "Listing schemes..."
          SCHEME_NAME=$(xcodebuild -list -project "$XCODE_PROJECT" | awk '/Schemes:/{flag=1; next} flag && /^[[:space:]]/{print $1; exit}')

          if [ -z "$SCHEME_NAME" ]; then
            echo "Error: Could not determine Scheme name."
            xcodebuild -list -project "$XCODE_PROJECT"
            exit 1
          fi

          echo "Found Project: $XCODE_PROJECT"
          echo "Building Scheme: $SCHEME_NAME"

          DERIVED_DATA="$(pwd)/dist/derived"

          xcodebuild build \
            -project "$XCODE_PROJECT" \
            -scheme "$SCHEME_NAME" \
            -configuration release \
            -destination "generic/platform=iOS" \
            -derivedDataPath "$DERIVED_DATA" \
            CODE_SIGNING_ALLOWED="NO" \
            CODE_SIGNING_REQUIRED="NO" \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE=""

          APP_DIR="$DERIVED_DATA/Build/Products/release-iphoneos"
          APP_PATH=$(find "$APP_DIR" -maxdepth 1 -type d -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find "$DERIVED_DATA/Build/Products" -type d -name "*.app" | head -n 1)
          fi
          if [ -z "$APP_PATH" ]; then
            echo "Error: Could not find built .app in $DERIVED_DATA"
            exit 1
          fi

          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"

      # 5. 手动打包成 IPA (Payload 法)
      # 这生成出来的包，就是用户可以用轻松签、爱思助手重签名的包
      - name: Export IPA
        run: |
          cd app/src-tauri/gen/apple/dist

          mkdir Payload
          cp -r "$APP_PATH" Payload/

          # 压缩生成 IPA
          TAG_NAME="${{ github.ref_name }}"
          IPA_NAME="todo_cross-${TAG_NAME}-ios-unsigned.ipa"
          zip -r "$IPA_NAME" Payload

          echo "IPA Created at $(pwd)/$IPA_NAME"

      - name: Stop Tauri iOS Options Server
        if: always()
        run: |
          if [ -n "${TAURI_IOS_OPTIONS_PID:-}" ]; then
            kill "$TAURI_IOS_OPTIONS_PID" || true
          fi
      - name: Upload Options Server Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-options-log
          path: /tmp/tauri-ios-options.log
          if-no-files-found: ignore

      # 6. 上传 Artifact (给用户下载)
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa
          path: app/src-tauri/gen/apple/dist/todo_cross-*-ios-unsigned.ipa

      - name: Upload IPA to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: app/src-tauri/gen/apple/dist/todo_cross-*-ios-unsigned.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
