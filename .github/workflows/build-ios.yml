name: "Build iOS"

on:
  push:
    branches:
      - release
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # 2. 安装依赖
      - name: Install Dependencies
        working-directory: ./app
        run: bun install

      # 3. 这里的关键：只让 Tauri 初始化项目并构建前端，不要让它尝试打包 IPA
      # 如果你的 tauri.conf.json 里的 bundle identifier 是自动生成的，确保它是固定的
      - name: Build Frontend & Init iOS Project
        working-directory: ./app
        run: |
          bun tauri build --no-bundle
          bun tauri ios init

      # 4. 手动调用 xcodebuild 进行归档
      # 解释参数：
      # - CODE_SIGNING_ALLOWED="YES": 必须开启，否则无法嵌入权限
      # - CODE_SIGNING_REQUIRED="YES": 同上
      # - CODE_SIGNING_IDENTITY="-": 关键！这代表 "Ad-Hoc Sign"，不需要证书
      # - AD_HOC_CODE_SIGNING_ALLOWED="YES": 允许伪签名
      # 用 find 命令找到 .xcodeproj，适应 tauri v1 或 v2 的路径差异
      - name: Xcode Archive (Ad-Hoc)
        run: |
          cd app/src-tauri/gen/apple

          # 获取 workspace 名称 (通常是 项目名.xcodeproj)
          XCODE_PROJECT=$(find . -name "*.xcodeproj" -maxdepth 1 | head -n 1)

          # 动态获取 Scheme 名称
          # xcodebuild -list 的输出包含了 Schemes: 接下来的行
          echo "Listing schemes..."
          SCHEME_NAME=$(xcodebuild -list -project "$XCODE_PROJECT" | awk '/Schemes:/{flag=1; next} flag && /^[[:space:]]/{print $1; exit}')

          if [ -z "$SCHEME_NAME" ]; then
            echo "Error: Could not determine Scheme name."
            xcodebuild -list -project "$XCODE_PROJECT"
            exit 1
          fi

          echo "Found Project: $XCODE_PROJECT"
          echo "Building Scheme: $SCHEME_NAME"

          xcodebuild archive \
            -project "$XCODE_PROJECT" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "dist/$SCHEME_NAME.xcarchive" \
            CODE_SIGNING_ALLOWED="YES" \
            CODE_SIGNING_REQUIRED="YES" \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_IDENTITY="-" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE=""

      # 5. 手动打包成 IPA (Payload 法)
      # 这生成出来的包，就是用户可以用轻松签、爱思助手重签名的包
      - name: Export IPA
        run: |
          cd app/src-tauri/gen/apple/dist

          # 找到刚才生成的 xcarchive
          ARCHIVE_PATH=$(find . -name "*.xcarchive" | head -n 1)
          APP_PATH="$ARCHIVE_PATH/Products/Applications"
          APP_NAME=$(ls "$APP_PATH" | head -n 1)

          mkdir Payload
          cp -r "$APP_PATH/$APP_NAME" Payload/

          # 压缩生成 IPA
          zip -r app-unsigned.ipa Payload

          echo "IPA Created at $(pwd)/app-unsigned.ipa"

      # 6. 上传 Artifact (给用户下载)
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa
          path: app/src-tauri/gen/apple/dist/app-unsigned.ipa
