name: "Build iOS"

on:
  push:
    branches:
      - main
      - release
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim

      - name: Install frontend dependencies
        working-directory: ./app
        run: bun install

      - name: Build iOS App (Unsigned)
        working-directory: ./app
        run: |
          # 1. --ci : 跳过交互式询问
          # 2. --target aarch64 : 编真机版
          # 3. CODE_SIGNING_ALLOWED=NO 等 : 关闭签名
          # 4. -destination : 解决目的地歧义
          # 5. DEVELOPMENT_TEAM="" : 确保不使用任何 Team

          bun tauri ios build --ci --target aarch64 -- \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            DEVELOPMENT_TEAM="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      - name: Package App for Distribution
        run: |
          mkdir -p ios-artifacts

          echo "Searching for .app bundle..."
          # 稍微放宽搜索条件，防止因为路径变动找不到
          # 排除掉模拟器(iphonesimulator)的包，只找真机(iphoneos)的包
          APP_PATH=$(find app/src-tauri/gen/apple/build -type d -name "*.app" | grep -v "iphonesimulator" | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "::error::Could not find .app bundle! Check build logs."
            find app/src-tauri/gen/apple/build -type d -name "*.app" # 打印出来看看都在哪
            exit 1
          fi

          echo "Found app at: $APP_PATH"

          # 创建 Payload 文件夹 (这是 IPA 的标准结构)
          rm -rf Payload
          mkdir Payload

          # 复制 .app 进去
          cp -r "$APP_PATH" Payload/

          # 压缩成 IPA
          zip -r "ios-artifacts/todo-app-unsigned.ipa" Payload

          # 顺便把 .app 也压个包，万一你要用模拟器测
          APP_NAME=$(basename "$APP_PATH")
          zip -r "ios-artifacts/$APP_NAME.zip" "$APP_PATH"

          echo "Packaging done:"
          ls -l ios-artifacts/

      - name: Upload Artifacts to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ios-artifacts/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifacts to Action Run
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: ios-artifacts/*
          if-no-files-found: warn
